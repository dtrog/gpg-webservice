<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - GPG Web Service</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üîß Admin Panel</h1>
            <p>Manage users and system operations</p>
        </header>

        <div class="admin-section">
            <h2>User Management</h2>
            
            <div class="card">
                <h3>List All Users</h3>
                <button onclick="listUsers()" class="btn btn-primary">Fetch Users</button>
                <div id="userList" class="user-list"></div>
            </div>

            <div class="card">
                <h3>Delete User</h3>
                <p>‚ö†Ô∏è Warning: This action cannot be undone!</p>
                <div class="form-group">
                    <label for="deleteUsername">Username:</label>
                    <input type="text" id="deleteUsername" placeholder="Enter username">
                </div>
                <div class="form-group">
                    <label for="adminApiKey">Admin API Key:</label>
                    <input type="password" id="adminApiKey" placeholder="Enter your API key">
                </div>
                <button onclick="deleteUser()" class="btn btn-danger">Delete User</button>
            </div>

            <div class="card">
                <h3>Bulk Delete Users</h3>
                <p>Delete multiple users at once (one username per line)</p>
                <div class="form-group">
                    <label for="bulkUsernames">Usernames:</label>
                    <textarea id="bulkUsernames" rows="5" placeholder="PrimeAI&#10;Auditor_Alpha&#10;Auditor_Beta"></textarea>
                </div>
                <div class="form-group">
                    <label for="bulkAdminApiKey">Admin API Key:</label>
                    <input type="password" id="bulkAdminApiKey" placeholder="Enter your API key">
                </div>
                <button onclick="bulkDeleteUsers()" class="btn btn-danger">Bulk Delete</button>
            </div>
        </div>

        <div id="resultArea" class="result-area"></div>

        <footer>
            <a href="index.html">‚Üê Back to Home</a>
        </footer>
    </div>

    <script src="js/app.js"></script>
    <script>
        async function listUsers() {
            const resultArea = document.getElementById('resultArea');
            const userList = document.getElementById('userList');
            
            try {
                resultArea.innerHTML = '<p class="loading">‚è≥ Fetching users...</p>';
                
                const response = await fetch(`${API_BASE}/admin/users`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (response.ok && data.users) {
                    userList.innerHTML = `
                        <div class="success">
                            <p><strong>Total Users:</strong> ${data.users.length}</p>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Created At</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.users.map(user => `
                                        <tr>
                                            <td><code>${user.username}</code></td>
                                            <td>${user.email || 'N/A'}</td>
                                            <td>${new Date(user.created_at).toLocaleString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    resultArea.innerHTML = '<p class="success">‚úÖ Users fetched successfully</p>';
                } else {
                    userList.innerHTML = '';
                    resultArea.innerHTML = `<p class="error">‚ùå Error: ${data.error || 'Failed to fetch users'}</p>`;
                }
            } catch (error) {
                userList.innerHTML = '';
                resultArea.innerHTML = `<p class="error">‚ùå Network error: ${error.message}</p>`;
            }
        }

        async function deleteUser() {
            const username = document.getElementById('deleteUsername').value.trim();
            const apiKey = document.getElementById('adminApiKey').value.trim();
            const resultArea = document.getElementById('resultArea');
            
            if (!username) {
                resultArea.innerHTML = '<p class="error">‚ùå Please enter a username</p>';
                return;
            }
            
            if (!apiKey) {
                resultArea.innerHTML = '<p class="error">‚ùå Please enter your API key</p>';
                return;
            }

            if (!confirm(`Are you sure you want to delete user "${username}"?`)) {
                return;
            }

            try {
                resultArea.innerHTML = '<p class="loading">‚è≥ Deleting user...</p>';
                
                const response = await fetch(`${API_BASE}/admin/users/${username}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-KEY': apiKey
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    resultArea.innerHTML = `<p class="success">‚úÖ User "${username}" deleted successfully</p>`;
                    document.getElementById('deleteUsername').value = '';
                    // Refresh user list if it was shown
                    const userListEl = document.getElementById('userList');
                    if (userListEl.innerHTML) {
                        listUsers();
                    }
                } else {
                    resultArea.innerHTML = `<p class="error">‚ùå Error: ${data.error || 'Failed to delete user'}</p>`;
                }
            } catch (error) {
                resultArea.innerHTML = `<p class="error">‚ùå Network error: ${error.message}</p>`;
            }
        }

        async function bulkDeleteUsers() {
            const usernames = document.getElementById('bulkUsernames').value
                .split('\n')
                .map(u => u.trim())
                .filter(u => u);
            const apiKey = document.getElementById('bulkAdminApiKey').value.trim();
            const resultArea = document.getElementById('resultArea');
            
            if (usernames.length === 0) {
                resultArea.innerHTML = '<p class="error">‚ùå Please enter at least one username</p>';
                return;
            }
            
            if (!apiKey) {
                resultArea.innerHTML = '<p class="error">‚ùå Please enter your API key</p>';
                return;
            }

            if (!confirm(`Are you sure you want to delete ${usernames.length} users?`)) {
                return;
            }

            try {
                resultArea.innerHTML = `<p class="loading">‚è≥ Deleting ${usernames.length} users...</p>`;
                
                const results = [];
                for (const username of usernames) {
                    const response = await fetch(`${API_BASE}/admin/users/${username}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-KEY': apiKey
                        }
                    });

                    const data = await response.json();
                    results.push({
                        username,
                        success: response.ok,
                        message: data.message || data.error
                    });
                }

                const successCount = results.filter(r => r.success).length;
                const failCount = results.length - successCount;

                let html = `<div class="${successCount === results.length ? 'success' : 'warning'}">`;
                html += `<p><strong>Completed:</strong> ${successCount} succeeded, ${failCount} failed</p>`;
                html += '<table><thead><tr><th>Username</th><th>Status</th></tr></thead><tbody>';
                results.forEach(r => {
                    html += `<tr>
                        <td><code>${r.username}</code></td>
                        <td class="${r.success ? 'success' : 'error'}">${r.success ? '‚úÖ Deleted' : '‚ùå ' + r.message}</td>
                    </tr>`;
                });
                html += '</tbody></table></div>';

                resultArea.innerHTML = html;
                
                if (successCount > 0) {
                    document.getElementById('bulkUsernames').value = '';
                    // Refresh user list if it was shown
                    const userListEl = document.getElementById('userList');
                    if (userListEl.innerHTML) {
                        listUsers();
                    }
                }
            } catch (error) {
                resultArea.innerHTML = `<p class="error">‚ùå Network error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
