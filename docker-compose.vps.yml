# Docker Compose override for VPS deployment with Caddy reverse proxy
# This file removes TLS from services since Caddy handles HTTPS externally
#
# Usage on VPS: docker compose -f docker-compose.yml -f docker-compose.vps.yml up -d

services:
  gpg-webservice-rest:
    environment:
      # Remove TLS - Caddy handles HTTPS
      - TLS_CERT=
      - TLS_KEY=
    # Override volumes completely to exclude TLS cert mounts
    volumes:
      - ./gpg-webservice-rest/gpg_users.db:/app/gpg_users.db
      - gpg-temp:/tmp/gnupg
    healthcheck:
      # Check HTTP instead of HTTPS
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:${FLASK_PORT:-5555}/openai/function_definitions')"]

  gpg-webservice-mcp:
    environment:
      # Use HTTP for backend API communication
      - GPG_API_BASE=http://gpg-webservice-rest:5555
      - NODE_TLS_REJECT_UNAUTHORIZED=
      # Remove TLS
      - TLS_CERT=
      - TLS_KEY=
    volumes: []
    healthcheck:
      # Already checking HTTP - no change needed
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:${MCP_PORT:-3000}/health"]

  gpg-webservice-dashboard:
    environment:
      # Point to Caddy-proxied API (external HTTPS endpoint)
      - API_URL=https://vps-b5527a39.vps.ovh.net/api
    volumes:
      # Override with static HTTP config (no TLS redirect)
      - ./gpg-webservice-dashboard/nginx.conf.static:/etc/nginx/conf.d/default.conf:ro
    healthcheck:
      # Already checking HTTP - no change needed
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
