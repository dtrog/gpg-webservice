# GPG Webservice Suite - Docker Compose
# ======================================
# Parent project with 3 subprojects:
#   - gpg-webservice-rest      (REST API - Required)
#   - gpg-webservice-mcp       (MCP Server - Optional)
#   - gpg-webservice-dashboard (Web UI - Optional)
#
# Usage:
#   docker compose up -d                           # Start all services
#   docker compose up -d gpg-webservice-rest       # Start only REST API
#   docker compose up -d gpg-webservice-rest gpg-webservice-mcp  # REST + MCP
#   docker compose logs -f                         # View logs
#   docker compose ps                              # Check status
#   docker compose down                            # Stop all services
#
# Development mode (with hot-reload):
#   docker compose -f docker-compose.yml -f docker-compose.dev.yml up -d

services:
  # =============================================================================
  # Flask REST API (Core Service - Required)
  # =============================================================================
  gpg-webservice-rest:
    container_name: gpg-webservice-rest
    build:
      context: ./gpg-webservice-rest
      dockerfile: Dockerfile
    ports:
      - "${FLASK_PORT:-5555}:${FLASK_PORT:-5555}"
    env_file:
      - .env
      - ./gpg-webservice-rest/.env
    environment:
      # Override with root .env values
      - PORT=${FLASK_PORT:-5555}
      - HOST=0.0.0.0
      - FLASK_ENV=${ENVIRONMENT:-development}
      - SERVICE_KEY_PASSPHRASE=${SERVICE_KEY_PASSPHRASE}
      - SECRET_KEY=${SECRET_KEY}
      - DATABASE=/app/gpg_users.db
    volumes:
      # Database persistence (SQLite stored in REST API directory)
      - ./gpg-webservice-rest/gpg_users.db:/app/gpg_users.db
      # GPG temporary directory
      - gpg-temp:/tmp/gnupg
    networks:
      - gpg-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:${FLASK_PORT:-5555}/openai/function_definitions')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  # =============================================================================
  # MCP Server (AI Agent Interface - Optional)
  # =============================================================================
  gpg-webservice-mcp:
    container_name: gpg-webservice-mcp
    build:
      context: ./gpg-webservice-mcp
      dockerfile: Dockerfile
    ports:
      - "${MCP_PORT:-3000}:${MCP_PORT:-3000}"
    env_file:
      - .env
    environment:
      - MCP_PORT=${MCP_PORT:-3000}
      - MCP_HOST=0.0.0.0
      - GPG_API_BASE=http://gpg-webservice-rest:5555
    depends_on:
      gpg-webservice-rest:
        condition: service_healthy
    networks:
      - gpg-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:${MCP_PORT:-3000}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # =============================================================================
  # Dashboard (Web UI - Optional)
  # =============================================================================
  gpg-webservice-dashboard:
    container_name: gpg-webservice-dashboard
    build:
      context: ./gpg-webservice-dashboard
      dockerfile: Dockerfile
    ports:
      - "${DASHBOARD_PORT:-8080}:80"
    environment:
      - API_URL=${API_URL:-http://localhost:5555}
    depends_on:
      gpg-webservice-rest:
        condition: service_healthy
    networks:
      - gpg-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    restart: unless-stopped

  # =============================================================================
  # Test Runner (Development/CI)
  # =============================================================================
  test-runner:
    container_name: gpg-test-runner
    build:
      context: ./gpg-webservice-rest
      dockerfile: Dockerfile
    command: python -m pytest tests/ -v
    env_file:
      - ./gpg-webservice-rest/.env
    environment:
      - GNUPGHOME=/tmp/gnupg
      - GPG_AGENT_INFO=""
      - GPG_TTY=""
      - DATABASE=/app/test.db
      - SERVICE_KEY_PASSPHRASE=${SERVICE_KEY_PASSPHRASE:-test-passphrase}
      - FLASK_ENV=testing
    volumes:
      - ./gpg-webservice-rest:/app
      - gpg-test-temp:/tmp/gnupg
    networks:
      - gpg-network
    profiles:
      - test

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  gpg-network:
    driver: bridge
    name: gpg-network

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  # GPG temporary directories (cleared on restart)
  gpg-temp:
    name: gpg-temp
  gpg-test-temp:
    name: gpg-test-temp
