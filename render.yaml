# Render Blueprint for GPG Webservice Suite
# ==========================================
# This file defines the infrastructure for deploying all three services:
# - gpg-webservice-rest (Flask REST API)
# - gpg-webservice-mcp (MCP Server)
# - gpg-webservice-dashboard (Nginx Static Dashboard)
#
# Deploy: Connect this repo to Render as a Blueprint
# Docs: https://render.com/docs/blueprint-spec

services:
  # =============================================================================
  # Unified Service (REST API + MCP + Dashboard in one container)
  # =============================================================================
  - type: web
    name: gpg-webservice
    runtime: docker
    dockerfilePath: ./Dockerfile.unified
    plan: starter
    region: oregon
    branch: main
    
    # Render sets PORT automatically; nginx listens on this port
    envVars:
      - key: FLASK_ENV
        value: production
      - key: ENVIRONMENT
        value: production
      - key: LOG_LEVEL
        value: INFO
      
      # CRITICAL SECRETS - Set these in Render Dashboard
      - key: SERVICE_KEY_PASSPHRASE
        sync: false
      - key: SECRET_KEY
        sync: false
      
      # Admin access control
      - key: ADMIN_USERNAMES
        sync: false
      - key: ADMIN_GPG_KEYS
        sync: false
      
      # Database
      - key: DATABASE
        value: /app/rest/gpg_users.db
      
      # Rate limiting
      - key: RATE_LIMIT_AUTH_REQUESTS
        value: 5
      - key: RATE_LIMIT_AUTH_WINDOW
        value: 60
      - key: RATE_LIMIT_API_REQUESTS
        value: 30
      - key: RATE_LIMIT_API_WINDOW
        value: 60
      
      # File uploads
      - key: MAX_FILE_SIZE_MB
        value: 10
      - key: MAX_SIGNATURE_SIZE_MB
        value: 1
      - key: MAX_CONTENT_LENGTH
        value: 16777216
      
      # GPG settings
      - key: GPG_KEY_LENGTH
        value: 3072
      - key: GPG_KEY_TYPE
        value: RSA
    
    # Persistent disk for SQLite database
    disk:
      name: gpg-data
      mountPath: /app/rest
      sizeGB: 1
    
    healthCheckPath: /api/openai/function_definitions
    
    autoDeploy: true

# =============================================================================
# DEPLOYMENT INSTRUCTIONS
# =============================================================================
#
# 1. BEFORE DEPLOYING:
#    - Push this render.yaml to your GitHub repository
#    - DO NOT commit secrets (SERVICE_KEY_PASSPHRASE, SECRET_KEY, etc.)
#
# 2. INITIAL DEPLOYMENT:
#    a. Go to Render Dashboard: https://dashboard.render.com/
#    b. Click "New" â†’ "Blueprint"
#    c. Connect your GitHub repository
#    d. Render will detect this render.yaml and show you the three services
#    e. Click "Apply" to create all services
#
# 3. SET REQUIRED SECRETS (in Render Dashboard):
#    
#    For gpg-webservice-rest:
#    - SERVICE_KEY_PASSPHRASE: Generate with `openssl rand -base64 32`
#    - SECRET_KEY: Generate with `openssl rand -hex 32`
#    - ADMIN_USERNAMES: Comma-separated list (e.g., "administrator,alice")
#    - ADMIN_GPG_KEYS: JSON string (see .env.example for format)
#
#    For gpg-webservice-mcp:
#    - GPG_API_BASE: Set to your REST service URL (e.g., https://gpg-webservice-rest.onrender.com)
#    - GPG_API_KEY: (Optional) API key for authenticated requests
#
#    For gpg-webservice-dashboard:
#    - API_URL: Set to your REST service URL (same as GPG_API_BASE)
#
# 4. VERIFY DEPLOYMENT:
#    - REST API: https://gpg-webservice-rest.onrender.com/
#    - MCP Server: https://gpg-webservice-mcp.onrender.com/health
#    - Dashboard: https://gpg-webservice-dashboard.onrender.com/
#
# 5. IMPORTANT NOTES:
#    - Render automatically handles HTTPS (TLS termination at edge)
#    - Services detect RENDER environment variable and skip local TLS
#    - Free tier services sleep after inactivity; first request may be slow
#    - Consider upgrading to paid plans for production use
#    - For PostgreSQL: Add a database in Render and update DATABASE env var
#
# =============================================================================
